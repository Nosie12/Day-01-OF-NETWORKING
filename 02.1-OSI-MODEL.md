# OSI Model: Traffic Flow and Encapsulation

## Overview  
- When two hosts communicate (e.g., Host A to Host B), data must be converted and prepared at both ends.  
- This process is called **encapsulation** (at the sender) and **de-encapsulation** (at the receiver).  
- Each layer in the OSI Model communicates only with its corresponding layer on the other host (Layer 7 talks to Layer 7, Layer 6 to Layer 6, etc.).

## Encapsulation Process  
- Data starts at the **Application Layer (Layer 7)** on the sender's device.  
- Each layer adds its own **header** to the data from the layer above, wrapping the data like nested envelopes.  
- The headers added at each layer provide information needed for that layer’s functions.  
- The layering goes down from:  
  - Application Layer  
  - Presentation Layer  
  - Session Layer  
  - Transport Layer  
  - Network Layer  
  - Data Link Layer  
  - Physical Layer  
- At the **Data Link Layer (Layer 2)**, a **frame check sequence** is added to detect errors during transmission.  
- At the **Physical Layer (Layer 1)**, data is transmitted as electrical or optical signals (bits: 0s and 1s).

## Practical Example  
- Imagine your PC opening a web connection to `Cisco.com`.  
- The data you send passes through all layers, getting encapsulated at each one with headers.  
- Finally, the bits are transmitted over the physical media (e.g., Ethernet cable).  
- On the receiving side, each layer strips off its corresponding header (de-encapsulation) until the original data reaches the application.

## Real-World Context  
- Networks can be complex, spanning multiple devices and media types between sender and receiver (e.g., between England and the USA).  
- However, the encapsulation process works the same regardless of network complexity.  

## Tools  
- **Wireshark** is a network protocol analyzer that lets you capture and inspect these encapsulated packets in real time, showing how data flows across the OSI layers.

---

# OSI Model: De-encapsulation and Data Units

## De-encapsulation Process  
- At the receiving end, the process is reversed: this is called **de-encapsulation**.  
- Data arrives as bits at the **Physical Layer** via the Network Interface Card (NIC).  
- Each layer removes (strips) its corresponding header and passes the remaining data up to the next higher layer.  
- This continues until all headers are removed and only the original data remains.  
- The application on the receiving device (e.g., a web server) then processes the data — for example, processing an HTTP GET request from a browser.

## Summary of Encapsulation and De-encapsulation  
- **Sender:** Data moves *down* the OSI layers, getting encapsulated with headers at each layer, then sent physically.  
- **Receiver:** Data moves *up* the OSI layers, getting headers removed at each layer (de-encapsulation), until the original data is processed by the receiving application.  
- Each layer communicates only with its **equivalent layer** on the other device.  
  - Application Layer ↔ Application Layer  
  - Presentation Layer ↔ Presentation Layer  
  - Session Layer ↔ Session Layer  
  - Transport Layer ↔ Transport Layer  
  - Network Layer ↔ Network Layer  
  - Data Link Layer ↔ Data Link Layer  
  - Physical Layer ↔ Physical Layer  

## Data Unit Terminology  
- Different layers use different terms to describe data units:  
  - **Physical Layer (Layer 1):** bits (0s and 1s transmitted as electrical or optical signals)  
  - **Data Link Layer (Layer 2):** frames  
  - **Network Layer (Layer 3):** packets  
  - **Transport Layer (Layer 4):** segments  
- For example:  
  - Routers operate at **Layer 3 (Network Layer)** and route **packets**.  
  - Switches operate at **Layer 2 (Data Link Layer)** and forward **frames**.

---

Understanding both the encapsulation/de-encapsulation process and the terminology for data units at each layer is key to grasping how networks function and communicate effectively.

---

# OSI Model Today and Protocol Differentiation

### Blurred Lines in Roles  
- Traditionally, **routers** transmit **packets** (Layer 3) and **switches** transmit **frames** (Layer 2).  
- However, with modern **Layer 3 switches**, these lines are less clear because such switches can also route packets.  
- Most network engineers focus on the **lower layers** of the OSI model (Transport, Network, Data Link, Physical).  
- This focus is shifting somewhat with virtualization (e.g., VMware), requiring broader knowledge.  

### OSI Model vs TCP/IP Model  
- The **OSI Model** has **7 layers**: Application (7), Presentation (6), Session (5), Transport (4), Network (3), Data Link (2), Physical (1).  
- It was originally designed for protocols like CLNS and CLNP, not TCP/IP.  
- The **TCP/IP model** simplifies this into 4 layers:  
  - Application (combines Application, Presentation, Session)  
  - Transport  
  - Internet (equivalent to Network)  
  - Network Access (combines Data Link and Physical)  
- Many network engineers use a **hybrid approach**, grouping the top three OSI layers into a single Application layer but still referring to the lower OSI layers individually.

### Protocol Differentiation at Host  
- When Host B receives traffic, it might receive multiple protocols simultaneously (e.g., Telnet and TFTP).  
- How does Host B know which traffic belongs to which application?  

**At the Data Link Layer:**  
- The NIC reads the **Type field** in the Ethernet frame.  
- This field identifies the **Network Layer protocol** (e.g., IPv4, IPv6, ARP).  
- This tells the device how to process the incoming data further.

**At the Network Layer:**  
- The **Protocol field** specifies the **Transport Layer protocol** (e.g., TCP or UDP).

**At the Transport Layer:**  
- The **Port number** specifies the specific application or service (e.g., Telnet, TFTP, HTTP).  
- For example:  
  - Telnet uses port **23**  
  - TFTP uses port **69**  
  - HTTP uses port **80**

Learning common port numbers is useful for networking and troubleshooting.

---

# Demonstrating OSI Model Traffic Capture with Wireshark

In this example, I'll show how traffic flows from my local PC to a router and then to Google.com, and how Wireshark can capture and display that traffic by OSI layer.

---

### Setting Up Wireshark Capture

- Open Wireshark and go to **Capture** > **Interfaces**.  
- Select the network interface you want to capture from (e.g., your local NIC).  
- Enable **Promiscuous Mode** to capture all traffic visible to the NIC, not just traffic destined for your PC.  
- Start capturing.

---

### Capturing Traffic

- Visit a website like **Google.com** to generate traffic.  
- Stop the capture once enough data is collected.

---

### Filtering and Analyzing Traffic

- Use the filter `http` to narrow down to HTTP traffic.  
- You will see packets from Google's IP (e.g., `142.250.190.206`) to your local PC's IP (e.g., `192.168.1.10`).  

---

### Examining a Frame

- The frame size is shown (e.g., 1514 bytes).  
- The **Ethernet frame** was sent from the Cisco router to your PC.  
- MAC addresses of both devices are visible.  
- The **Type field** indicates the Layer 3 protocol (IPv4 here, `0x0800` in hex).  
- IP version 4 is being used, with source and destination IP addresses shown.  
- Quality of Service info is visible via **Differentiated Services Code Points (DSCP)**.

---

### Layer 4 (Transport Layer) Details

- Protocol is **TCP** (`protocol number 6` at Layer 3).  
- Source port is Google's well-known HTTP port 80.  
- Destination port is an ephemeral port on your PC, used for this session.  
- TCP fields like **sequence numbers**, **acknowledgement**, and **window size** ensure reliable data transmission.  

---

### Application Layer

- HTTP data is visible, compressed with gzip.  
- You can see content like HTML tags, references to Google resources, and scripts.  
- This gives insight into what your browser is actually receiving from Google.

---

### Summary

- This example shows an IPv4 packet flowing through layers:  
  - Layer 2 (Data Link - Ethernet)  
  - Layer 3 (Network - IPv4)  
  - Layer 4 (Transport - TCP)  
  - Layer 7 (Application - HTTP)  

- Wireshark lets us capture and dissect these layers, revealing the encapsulation and headers added at each stage.



Understanding encapsulation and how each layer adds and removes headers is key to troubleshooting and designing networks effectively.
